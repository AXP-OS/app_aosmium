From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: quh4gko8 <88831734+quh4gko8@users.noreply.github.com>
Date: Wed, 12 Jun 2024 16:15:42 +0000
Subject: [PATCH] Match skipping compatibility check default value checks in
 java as well

---
 .../options/AutofillOptionsMediator.java      |  2 +-
 .../ui/autofill/autofill_client_provider.cc   | 34 +++++++++++++++++--
 .../autofill/core/common/autofill_features.cc |  7 ++++
 .../autofill/core/common/autofill_features.h  | 23 +++++++++++++
 4 files changed, 63 insertions(+), 3 deletions(-)

diff --git a/chrome/browser/autofill/android/java/src/org/chromium/chrome/browser/autofill/options/AutofillOptionsMediator.java b/chrome/browser/autofill/android/java/src/org/chromium/chrome/browser/autofill/options/AutofillOptionsMediator.java
index 8e26b26c2d83c..5553daa417cd5 100644
--- a/chrome/browser/autofill/android/java/src/org/chromium/chrome/browser/autofill/options/AutofillOptionsMediator.java
+++ b/chrome/browser/autofill/android/java/src/org/chromium/chrome/browser/autofill/options/AutofillOptionsMediator.java
@@ -169,7 +169,7 @@ class AutofillOptionsMediator implements ModalDialogProperties.Controller {
             case AndroidAutofillAvailabilityStatus.ANDROID_AUTOFILL_NOT_SUPPORTED:
             case AndroidAutofillAvailabilityStatus.UNKNOWN_ANDROID_AUTOFILL_SERVICE:
             case AndroidAutofillAvailabilityStatus.ANDROID_AUTOFILL_SERVICE_IS_GOOGLE:
-                return true;
+                return false; // Pref can't be read only.
             case AndroidAutofillAvailabilityStatus.SETTING_TURNED_OFF: // Pref may be changed!
             case AndroidAutofillAvailabilityStatus.AVAILABLE:
                 return false;
diff --git a/chrome/browser/ui/autofill/autofill_client_provider.cc b/chrome/browser/ui/autofill/autofill_client_provider.cc
index 1e4e36b0fd8ec..97b4fe30c91e8 100644
--- a/chrome/browser/ui/autofill/autofill_client_provider.cc
+++ b/chrome/browser/ui/autofill/autofill_client_provider.cc
@@ -67,9 +67,35 @@ void SetSharedPrefForSettingsContentProvider(bool uses_platform_autofill) {
 
 AndroidAutofillAvailabilityStatus GetAndroidAutofillAvailabilityStatus(
     PrefService& prefs) {
-  return static_cast<AndroidAutofillAvailabilityStatus>(
+  AndroidAutofillAvailabilityStatus availability = static_cast<
+      AndroidAutofillAvailabilityStatus>(
       Java_AutofillClientProviderUtils_getAndroidAutofillFrameworkAvailability(
           base::android::AttachCurrentThread(), &prefs));
+  // Check whether the returned availability is affected by feature parameters
+  // that skip some checks on this client.
+  switch (availability) {
+    case AndroidAutofillAvailabilityStatus::kAndroidAutofillServiceIsGoogle:
+      if (features::kAutofillVirtualViewStructureAndroidSkipsCompatibilityCheck
+              .Get() ==
+          features::VirtualViewStructureSkipChecks::kOnlySkipAwGCheck) {
+        availability = AndroidAutofillAvailabilityStatus::kAvailable;
+      }
+      ABSL_FALLTHROUGH_INTENDED;  // No skip-awg-check but skip-all may apply.
+    case AndroidAutofillAvailabilityStatus::kAndroidAutofillManagerNotAvailable:
+    case AndroidAutofillAvailabilityStatus::kAndroidAutofillNotSupported:
+    case AndroidAutofillAvailabilityStatus::kUnknownAndroidAutofillService:
+      if (features::kAutofillVirtualViewStructureAndroidSkipsCompatibilityCheck
+              .Get() ==
+          features::VirtualViewStructureSkipChecks::kSkipAllChecks) {
+        availability = AndroidAutofillAvailabilityStatus::kAvailable;
+      }
+      return availability;
+    case AndroidAutofillAvailabilityStatus::kAvailable:
+    case AndroidAutofillAvailabilityStatus::kSettingTurnedOff:
+    case AndroidAutofillAvailabilityStatus::kNotAllowedByPolicy:
+      return availability;
+  }
+  NOTREACHED();
 }
 #endif  // BUILDFLAG(IS_ANDROID)
 
@@ -88,7 +114,11 @@ bool UsesVirtualViewStructureForAutofill(PrefService& prefs) {
 
 AutofillClientProvider::AutofillClientProvider(PrefService* prefs)
     : uses_platform_autofill_(
-          UsesVirtualViewStructureForAutofill(CHECK_DEREF(prefs))) {
+          UsesVirtualViewStructureForAutofill(CHECK_DEREF(prefs))
+#if BUILDFLAG(IS_ANDROID)
+        && prefs->GetBoolean(prefs::kAutofillUsingPlatformAutofill)
+#endif // BUILDFLAG(IS_ANDROID)
+    ) {
 #if BUILDFLAG(IS_ANDROID)
   RecordWhetherAndroidPrefResets(*prefs, uses_platform_autofill_);
   // Ensure the pref is reset if platform autofill is restricted.
diff --git a/components/autofill/core/common/autofill_features.cc b/components/autofill/core/common/autofill_features.cc
index dc064c487ec6e..848ac5302aeb5 100644
--- a/components/autofill/core/common/autofill_features.cc
+++ b/components/autofill/core/common/autofill_features.cc
@@ -899,6 +899,13 @@ BASE_FEATURE(kAutofillSupportSplitZipCode, base::FEATURE_DISABLED_BY_DEFAULT);
 // virtual view structures to third party providers.
 BASE_FEATURE(kAutofillThirdPartyModeContentProvider,
              base::FEATURE_ENABLED_BY_DEFAULT);
+ 
+// Controls the whether the Chrome may provide a virtual view structure for
+// Android Autofill.
+// TODO: crbug.com/409579377 - Delete after M139.
+BASE_FEATURE(kAutofillVirtualViewStructureAndroid,
+             "AutofillVirtualViewStructureAndroid",
+             base::FEATURE_ENABLED_BY_DEFAULT);
 
 // If enabled, stores the last used Autofill Service in a pref. This allows to
 // restore the user's preference to use platform Autofill on restart.
diff --git a/components/autofill/core/common/autofill_features.h b/components/autofill/core/common/autofill_features.h
index 8c71570517ca6..93dca5d789068 100644
--- a/components/autofill/core/common/autofill_features.h
+++ b/components/autofill/core/common/autofill_features.h
@@ -306,6 +306,29 @@ COMPONENT_EXPORT(AUTOFILL) BASE_DECLARE_FEATURE(kAutofillSupportSplitZipCode);
 COMPONENT_EXPORT(AUTOFILL)
 BASE_DECLARE_FEATURE(kAutofillThirdPartyModeContentProvider);
 COMPONENT_EXPORT(AUTOFILL)
+BASE_DECLARE_FEATURE(kAutofillVirtualViewStructureAndroid);
+
+// Used as param for `kAutofillVirtualViewStructureAndroid` to allow
+// skipping certain checks when testing manually.
+enum class VirtualViewStructureSkipChecks {
+  kDontSkip = 0,
+  kSkipAllChecks = 1,
+  kOnlySkipAwGCheck = 2,
+};
+
+inline constexpr base::FeatureParam<VirtualViewStructureSkipChecks>::Option
+    kVirtualViewStructureSkipChecksOption[] = {
+        {VirtualViewStructureSkipChecks::kDontSkip, "dont_skip"},
+        {VirtualViewStructureSkipChecks::kSkipAllChecks, "skip_all_checks"},
+        {VirtualViewStructureSkipChecks::kOnlySkipAwGCheck,
+         "only_skip_awg_check"},
+};
+inline constexpr base::FeatureParam<VirtualViewStructureSkipChecks>
+    kAutofillVirtualViewStructureAndroidSkipsCompatibilityCheck{
+        &kAutofillVirtualViewStructureAndroid, "skip_compatibility_check",
+        VirtualViewStructureSkipChecks::kSkipAllChecks,
+        &kVirtualViewStructureSkipChecksOption};
+COMPONENT_EXPORT(AUTOFILL)
 BASE_DECLARE_FEATURE(kAutofillThirdPartyModeRestoredOnStart);
 #endif  // BUILDFLAG(IS_ANDROID)
 COMPONENT_EXPORT(AUTOFILL) BASE_DECLARE_FEATURE(kAutofillUKMExperimentalFields);
